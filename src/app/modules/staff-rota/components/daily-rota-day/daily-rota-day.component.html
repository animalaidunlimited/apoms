<form [formGroup]="rotaDayForm">  

  <table  mat-table [dataSource]="dataSource" class="day-rota-table" formArrayName="rotaDayAssignments">    

        <ng-container matColumnDef="rotationArea">
          <th mat-header-cell *matHeaderCellDef class="first-column">
            <button mat-mini-fab [color]="rotaDayForm.pristine ? 'primary' : 'warn'" (click)="saveRotaDay()" matTooltip="Save rota"
            [disabled]="rotaDayForm.invalid">
              <mat-icon>save</mat-icon>
            </button>
          </th>
          <td mat-cell *matCellDef="let element"
          class="area-header first-column"
          [attr.rowspan]="element.get('areaRowSpan')?.value"
          [style.display]="element.get('areaRowSpan')?.value !== 0  ? '' : 'none'"
          
          [ngStyle]="{backgroundColor: element.get('rotationAreaColour')?.value}">

            <div *ngIf="!element.get('isAdded')?.value"
            (click)="showAreaStaffCoverage(element.get('rotationArea')?.value, element.get('rotationAreaId')?.value)">
              {{element.get('rotationArea')?.value}}
            </div> 

            <div *ngIf="element.get('isAdded')?.value">

              <button
                class="delete-shift-button"
                type="button"
                (click)="deleteShift(element)"
                mat-mini-fab
                color="warn">
                <mat-icon>delete</mat-icon>
              </button>

            </div>
          </td>
        </ng-container>
      
        <ng-container matColumnDef="rotationRole">
          <th mat-header-cell *matHeaderCellDef> Rotation Role </th>
          <td mat-cell *matCellDef="let element; let i = index">
            
            <div *ngIf="!element.get('isAdded')?.value"
              style="width: 76px;">
              {{element.get('rotationRole')?.value}}
            </div>         

            <div [formGroupName]="i" *ngIf="element.get('isAdded')?.value"
            class="select-field non-form-field-input"
            style="width: 76px;">

              <mat-select
              style="text-align: center;"
              (selectionChange)="roleSelected($event.value, element)"
              [errorStateMatcher]="errorMatcher">
                <mat-option>N/A</mat-option>
                    <mat-option *ngFor="let role of rotationRoles$ | async" [value]="role">
                    {{role.rotationRole}}
                </mat-option>
              </mat-select>

            </div>

          </td>
        </ng-container>
      
        <ng-container matColumnDef="userId">
          <th mat-header-cell *matHeaderCellDef class="who-header" >
            
              <div class="flex-row flex-center-center">
                  <div style="margin-left: 25px;">Who</div>
                  <div >
                    <div class="who-icon flex-row flex-start-start" style="margin-left: 10px;">
                      <button mat-icon-button matTooltip="Show empty shifts only" [disabled]="userSearch !== ''" (click)="showEmptyShiftsOnly()">
                        <mat-icon 
                        matTooltip="Show all shifts" style="color: orange;" *ngIf="showEmptyShifts">person_off</mat-icon>                
                      
                        <mat-icon 
                        matTooltip="Show empty shifts" *ngIf="!showEmptyShifts">person</mat-icon>
                      </button>
                      <button mat-icon-button matTooltip="Search staff" [disabled]="showEmptyShifts" (click)="toggleUserFilter()">
                        <mat-icon
                        [ngStyle]="{'color' : showUserFilter || userSearch !== '' ? 'orange' : 'unset'}">person_search</mat-icon>   
                      </button>
                                     
                    </div>
                  </div>
                
              </div>

              <div class="user-search flex-row flex-space-between-center" *ngIf="showUserFilter" >
                <mat-form-field >
                  <input matInput type="text" (keyup)="searchUsers($event)" #userSearchInput autocomplete="off">
                  <button matSuffix mat-icon-button aria-label="Clear" (click)="userSearchInput.value = ''; clearAndCloseUserSearch()">
                    <mat-icon>clear</mat-icon>
                  </button>
                </mat-form-field> 
              </div>
              


          </th>
          <td mat-cell *matCellDef="let element; let i = index;" style="max-width: 200px;"> 

            
            <div [formGroupName]="i">

              <div *ngIf="element.get('leaveUser')?.value && element.get('leaveGranted')?.value === 'Granted'"
              class="granted-leave-user">
                {{element.get('leaveUser')?.value}}
              </div>    

                <app-user-autocomplete formControlName="userId" [formField]="false" [showLabel]="false" [existingUsersList]="assignedUsers" (selectionMade)="updateSelectedUsers()"
                class="select-field"
                style="min-width: 100px;">

                  <mat-icon 
                  *ngIf="element.get('leaveGranted')?.value === 'Pending' || element.get('leaveGranted')?.value === 'Denied'; let leave"
                  matTooltipClass="leave-tooltip"
                  [ngClass]="element.get('leaveGranted')?.value === 'Pending' ? 'leave-pending' : 'leave-denied'"
                  class="leave-icon"
                  [matTooltip]="element.get('leaveGranted')?.value"
                  matSuffix >event_busy</mat-icon>

                </app-user-autocomplete>

            </div>
          
            
          
          </td>
        </ng-container>
      
        <!-- <ng-container matColumnDef="plannedStartTime">
          <th mat-header-cell *matHeaderCellDef> Start time </th>
          <td mat-cell *matCellDef="let element"> <span *ngIf="element.get('rotationAreaId')?.value !== -2">{{element.get('plannedShiftStartTime')?.value}}</span></td>
        </ng-container>
      
        <ng-container matColumnDef="plannedEndTime">
          <th mat-header-cell *matHeaderCellDef> End time </th>
          <td mat-cell *matCellDef="let element"> <span *ngIf="element.get('rotationAreaId')?.value !== -2">{{element.get('plannedShiftEndTime')?.value}}</span></td>
        </ng-container>
      
        <ng-container matColumnDef="actualStartTime">
          <th mat-header-cell *matHeaderCellDef> Real start </th>
          <td mat-cell *matCellDef="let element; let i = index;">
            <div [formGroupName]="i" class="time-field" *ngIf="element.get('rotationAreaId')?.value !== -2">
              <input matInput class="non-form-field-input" autocomplete="off"
              #shiftStart
              [ngClass]=" element.get('actualShiftStartTime')?.errors ? 'time-error' : ''"
              formControlName="actualShiftStartTime" type="time" (blur)="checkActualTimes(element, shiftStart, 'actualShiftStartTime', 'actualShiftEndTime')"/>  
            </div>  
          </td>
        </ng-container>
      
        <ng-container matColumnDef="actualEndTime">
          <th mat-header-cell *matHeaderCellDef> Real end </th>
          <td mat-cell *matCellDef="let element; let i = index;"> 
            <div [formGroupName]="i" class="time-field" *ngIf="element.get('rotationAreaId')?.value !== -2">
              <input matInput class="non-form-field-input" autocomplete="off"
              #shiftEnd
              [ngClass]="element.get('actualShiftEndTime')?.errors ? 'time-error' : ''"
              formControlName="actualShiftEndTime" type="time" (blur)="checkActualTimes(element, shiftEnd, 'actualShiftEndTime', 'actualShiftStartTime')"/>
            </div>
          </td>
        </ng-container>



        <ng-container matColumnDef="plannedBreakStartTime">
          <th mat-header-cell *matHeaderCellDef> Break start </th>
          <td mat-cell *matCellDef="let element"> <span *ngIf="element.get('rotationAreaId')?.value !== -2">{{element.get('plannedBreakStartTime')?.value}}</span></td>
        </ng-container>
      
        <ng-container matColumnDef="plannedBreakEndTime">
          <th mat-header-cell *matHeaderCellDef> Break end </th>
          <td mat-cell *matCellDef="let element"> <span *ngIf="element.get('rotationAreaId')?.value !== -2">{{element.get('plannedBreakEndTime')?.value}}</span></td>
        </ng-container>
      
        <ng-container matColumnDef="actualBreakStartTime">
          <th mat-header-cell *matHeaderCellDef> Real break start </th>
          <td mat-cell *matCellDef="let element; let i = index;">
            <div [formGroupName]="i" class="time-field" *ngIf="element.get('rotationAreaId')?.value !== -2">
              <input matInput class="non-form-field-input" autocomplete="off"
              #breakStart
              [ngClass]=" element.get('actualBreakStartTime')?.errors ? 'time-error' : ''"
              formControlName="actualBreakStartTime" type="time" (blur)="checkActualTimes(element, breakStart, 'actualBreakStartTime', 'actualBreakEndTime')"/>  
            </div>  
          </td>
        </ng-container>
      
        <ng-container matColumnDef="actualBreakEndTime">
          <th mat-header-cell *matHeaderCellDef> Real break end </th>
          <td mat-cell *matCellDef="let element; let i = index;"> 
            <div [formGroupName]="i" class="time-field" *ngIf="element.get('rotationAreaId')?.value !== -2">
              <input matInput class="non-form-field-input"
              #breakEnd
              [ngClass]=" element.get('actualBreakEndTime')?.errors ? 'time-error' : ''"
              autocomplete="off" formControlName="actualBreakEndTime" type="time" (blur)="checkActualTimes(element, breakEnd, 'actualBreakEndTime', 'actualBreakStartTime')"/>  
            </div>
          </td>
        </ng-container> -->

        <ng-container matColumnDef="notes">
          <th mat-header-cell *matHeaderCellDef> Notes </th>
          <td mat-cell *matCellDef="let element; let i = index;"> 
            <div [formGroupName]="i" class="notes-field">
              <input matInput class="non-form-field-input" autocomplete="off" formControlName="notes" type="text"/>  
            </div>
           </td>
        </ng-container>    
  
    <tr mat-header-row *matHeaderRowDef="displayedColumns sticky: true;"></tr>
    <tr mat-row *matRowDef="let row; columns: displayedColumns; let i = dataIndex" ></tr>
  </table>

  <div class="flex-row flex-center-center gap-20" style="margin-top: 20px;">

    <button
      type="button"
      (click)="addShift()"
      mat-mini-fab
      color="primary">
      <mat-icon>add</mat-icon>
    </button>

  </div>

  <div class="flex-row gap-20" style="margin-top: 20px;">

    <div>
      <div class="user-list-heading">Unassigned staff</div>

      <div *ngFor="let user of (unassignedStaff | async)">        
        {{ user.employeeNumber + ' - ' + user.firstName }}
      </div>

    </div>

    <div>
      <div class="user-list-heading">Underutilised staff</div>
  
      <div *ngFor="let user of utilisation | async"  style="margin-bottom: 10px;">
        <div *ngIf="user.utilisation === 'under'">
          {{ user.userCode + ": " + (user.hours | date: 'HH:mm')}}
        </div>
      </div>

      <div class="user-list-heading">Overutilised staff</div>
  
      <div *ngFor="let user of utilisation | async">
        <div *ngIf="user.utilisation === 'over'">
          {{ user.userCode + ": " + (user.hours | date: 'HH:mm')}}
        </div>
      </div>
  
    </div>


  </div>




</form>
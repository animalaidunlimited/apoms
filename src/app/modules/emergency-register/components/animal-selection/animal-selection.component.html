<fieldset class="form-sub-group" fxLayout="column">

    <legend class="legend">Patient details</legend>

    <div fxFlex>

        <table mat-table #patientTable [dataSource]="patientDataSource" class="mat-elevation-z8 table">

            <ng-container matColumnDef="animalType">
                <th mat-header-cell *matHeaderCellDef #speciesLabel> Species </th>
                <td mat-cell *matCellDef="let row" (click)="toggleRow(row)"
                [class.invalid-cell]="row.invalid && row.get('animalType')?.value == ''"> {{row.get("animalType")?.value}} <p style="color:red" *ngIf="row.invalid && row.get('animalType')?.value == ''">  Species</p> </td>
            </ng-container>

            <ng-container matColumnDef="mainProblem">
                    <th mat-header-cell *matHeaderCellDef> Main problem(s) </th>
                    <td mat-cell *matCellDef="let row" 
                    [class.invalid-cell]="row.invalid && row.get('problemsString')?.value == ''"  >
                    <!-- (click)="toggleRow(row)"  -->
                    <div fxLayout="row">
                     
                        <mat-chip-list *ngIf="row.get('problemsString')?.value !== ''" >
                          <mat-chip 
                            tabindex="8"
                            *ngFor="let problem of row.get('problemsString')?.value.split(',')"
                            #problemChips
                            [selectable]="selectable"
                            [removable]="removable"
                            (removed)="remove(problem)">
                            {{problem}}
                            <mat-icon matChipRemove *ngIf="removable">cancel</mat-icon>
                          </mat-chip>
                        </mat-chip-list>
                        <input
                        tabindex="9"
                        type="text"
                        matInput
                        #poblemAuto
                        (keydown.tab)="tabPressed('ProblemType')"
                        (focus)="checkSpecies()"
                        (click)="$event.stopPropagation()"
                        (focusout)="setMainProblemError()"
                        [formControl]="problemInput"
                        [matAutocomplete]="auto"
                        style="height: 2.2rem;width: 5rem;border-bottom: 1px solid lightgray;"
                      >
                    </div>
                    <mat-autocomplete #auto="matAutocomplete" (optionSelected)="selected($event)">
                      <mat-option *ngFor="let problem of (filteredProblems | async)" [value]="problem">
                        {{problem.Problem}}
                      </mat-option>
                    </mat-autocomplete>
                    

                    

                    <p (click)="changeFocusToProblemsSelection($event)" style="color:red; margin-top: -1.3rem;" *ngIf="row.invalid && row.get('problemsString')?.value == '' && showMainProblemError">  Main problem(s)</p>
                  
                  
                  
                  </td>
            </ng-container>

            <ng-container matColumnDef="tagNo">
                    
                    <th mat-header-cell *matHeaderCellDef> Tag number </th>
                    <td mat-cell *matCellDef="let row"
                    (click)="selectIfNotSelected(row); updateTag(row)"
                    [class.invalid-cell]="recordForm.get('callOutcome.CallOutcome')?.value?.CallOutcomeId === 1 && !row.get('tagNumber')?.value"
                    [ngClass]="{
                        duplicate: row.get('duplicateTag')?.value == 'INVALID',
                        pending: row.get('duplicateTag')?.value == 'PENDING'
                    }"
                    style="cursor:pointer"> 
                        
                        {{row.get("tagNumber")?.value}} 
                        <p style="color:red" *ngIf="recordForm.get('callOutcome.CallOutcome')?.value?.CallOutcomeId === 1 && !row.get('tagNumber')?.value">  Tag number</p>
                    </td>
            </ng-container>

            <ng-container matColumnDef="media">
                <th mat-header-cell *matHeaderCellDef>Media</th>
                <td mat-cell *matCellDef="let row">
                    <mat-icon (click)="selectIfNotSelected(row); openMediaDialog(row)" style="cursor:pointer; padding-left: 10px">add_photo_alternate</mat-icon>
                </td>
            </ng-container>

            <ng-container matColumnDef="print">
                <th mat-header-cell *matHeaderCellDef>Print card</th>
                <td mat-cell *matCellDef="let row">
                    <mat-icon (click)="selectIfNotSelected(row); printEmergencyCard(row)" style="cursor:pointer; padding-left: 10px">print</mat-icon>
                </td>
            </ng-container>

            <ng-container matColumnDef="delete">
                <th mat-header-cell *matHeaderCellDef>Delete</th>
                <td mat-cell *matCellDef="let row">
                    <mat-icon (click)="deletePatientRow(row)" *ngIf="!row.get('deleted')?.value" style="cursor:pointer">delete</mat-icon>
                    <mat-icon (click)="deletePatientRow(row)" *ngIf="row.get('deleted')?.value" style="cursor:pointer">undo</mat-icon>
                </td>
            </ng-container>

            <tr mat-header-row *matHeaderRowDef="patientArrayDisplayedColumns"></tr>
            <tr (click)="toggleRow(row)" [class.patientSelected]="selection.isSelected(row)" mat-row *matRowDef="let row; columns: patientArrayDisplayedColumns;"
            [class.deleted]="row.get('deleted')?.value"
            [class.invalid-row]="row.invalid && showMainProblemError"></tr>


        </table>

    </div>
    <div fxLayout="row-reverse">
        <button #addPatientBtn class="addCallerButton" type="button" (click)="addPatientRow()" mat-mini-fab color="primary">
            <mat-icon>add</mat-icon>
        </button>
    </div>
    <div>

            <label class="label">Species</label>

            <mat-chip-list #animalTypeChips aria-label="Patient animalType\type" selectable>
                <mat-chip
                tabindex="7"
                (click)="animalTypeChip.toggleSelected()"
                (keydown.tab)="tabPressed('AnimalType')"
                (keydown.shift.tab)="shiftTabPressed('AnimalType')"
                (keydown)="cycleChips($event, 'animaltype', 'animalType')"
                (selectionChange)="animalChipSelected(animalTypeChip);"
                #animalTypeChip="matChip"
                *ngFor="let animalType of animalTypes$">{{animalType.AnimalType}}</mat-chip>
        </mat-chip-list>

    </div>
      </fieldset>

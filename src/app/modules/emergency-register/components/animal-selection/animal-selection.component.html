<fieldset class="form-sub-group" fxLayout="column">
    <legend class="legend">Patient details</legend>

    <div fxFlex>
        <table
            mat-table
            #patientTable
            [dataSource]="patientDataSource"
            class="mat-elevation-z8 table"
        >

            <ng-container matColumnDef="animalType">
                <th mat-header-cell *matHeaderCellDef >Species</th>
                <td mat-cell *matCellDef="let row; let i = index;" (click)="toggleRow(row)" [class.invalid-cell]="row.invalid && showSpeciesError[i]" style="width: 7rem;">
                    <input
                        type="text"
                        tabindex="7"
                        matInput
                        #speciesInput
                        [formControl]="animalInput"
                        [matAutocomplete]="auto"
                        class="speciesTypeList"
                        [fxShow]="showSpeciesTypeList[i]"
                        (keydown.tab)="tabPressed($event,i)"
                        (focusout)="speciesFocusOut($event?.target,i)"
                    />
                
                    <mat-autocomplete #auto="matAutocomplete" (optionSelected)="animalSelected($event,i)">
                        <mat-option (click)="speciesOptionClick(i)"
                            *ngFor="let animal of filteredAnimalTypes | async"
                            [value]="animal.AnimalTypeId"
                            >{{ animal.AnimalType }}</mat-option
                        >
                    </mat-autocomplete>
                    <p 
                        tabindex="7"
                        (focus)="changeFocusToSpeciesSelection($event,i)" 
                        (click)="changeFocusToSpeciesSelection($event,i)" 
                        style="color:red" 
                        [fxShow]="showSpeciesError[i]" 
                        *ngIf="row.invalid ">
                        Species
                    </p>
                </td>
            </ng-container>

            <ng-container matColumnDef="mainProblem">
                <th mat-header-cell *matHeaderCellDef>Main problem(s)</th>
                <td mat-cell *matCellDef="let row; let i = index;" (click)="toggleRow(row)" [class.invalid-cell]="row.invalid && showMainProblemError[i]" style="width: 30rem;">
                    <!-- [fxShow]="showMainProbelmChipList[i]" -->
                    <mat-chip-list #problemChips >
                        <div>
                            <input 
                                type="text"
                                tabindex="8"
                                matInput
                                #problemAuto
                                (keydown.shift.tab)="shiftTabPressed($event,i)"
                                [matChipInputFor]="problemChips"
                                (click)="checkRowSelected($event,row)"
                                (focus)="checkSpecies(row,i)"
                                (focusout)="setMainProblemError(row, i)"
                                [formControl]="problemInput"
                                [matAutocomplete]="auto"
                                class="problemList"
                            />
                        </div>
                        <div>
                            <mat-chip
                                *ngFor="let problem of row.get('problems')?.value"
                                [selectable]="selectable"
                                [removable]="removable"
                                (removed)="remove(problem.problemId)">
                                {{ problem.problem}}
                                <mat-icon matChipRemove *ngIf="removable" >cancel</mat-icon>
                            </mat-chip>
                        </div>
                    </mat-chip-list>

                    <mat-autocomplete #auto="matAutocomplete" (optionSelected)="updatePatientProblemArray($event)">
                        <mat-option
                            *ngFor="let problem of filteredProblems | async"
                            [value]="problem.ProblemId"
                        >
                            {{ problem.Problem }}
                        </mat-option>
                    </mat-autocomplete>
                     <!-- <p [fxShow]="showMainProblemError[i]"  tabindex="8" (focus)="changeFocusToProblemsSelection($event,i)" (click)="changeFocusToProblemsSelection($event,i)" style="color:red;" >  Main problem(s)</p> -->
                </td>
            </ng-container>

            <ng-container matColumnDef="tagNo">
                <th mat-header-cell *matHeaderCellDef>Tag number</th>
                <td
                    mat-cell
                    *matCellDef="let row"
                    (click)="selectIfNotSelected(row); updateTag(row)"
                    [class.invalid-cell]="
                        recordForm.get('callOutcome.CallOutcome')?.value
                            ?.CallOutcomeId === 1 &&
                        !row.get('tagNumber')?.value
                    "
                    [ngClass]="{
                        duplicate: row.get('duplicateTag')?.value == 'INVALID',
                        pending: row.get('duplicateTag')?.value == 'PENDING'
                    }"
                    style="cursor:pointer"
                >
                    {{ row.get('tagNumber')?.value }}
                    <p
                        style="color:red"
                        *ngIf="
                            recordForm.get('callOutcome.CallOutcome')?.value
                                ?.CallOutcomeId === 1 &&
                            !row.get('tagNumber')?.value
                        "
                    >
                        Tag number
                    </p>
                </td>
            </ng-container>

            <ng-container matColumnDef="media">
                <th mat-header-cell *matHeaderCellDef>Media</th>
                <td mat-cell *matCellDef="let row">
                    <mat-icon
                        (click)="selectIfNotSelected(row); openMediaDialog(row)"
                        style="cursor:pointer; padding-left: 10px"
                    >
                        add_photo_alternate</mat-icon
                    >
                </td>
            </ng-container>

            <ng-container matColumnDef="print">
                <th mat-header-cell *matHeaderCellDef>Print card</th>
                <td mat-cell *matCellDef="let row">
                    <mat-icon
                        (click)="selectIfNotSelected(row); printEmergencyCard(row)"
                        style="cursor:pointer; padding-left: 10px"
                        >print</mat-icon
                    >
                </td>
            </ng-container>

            <ng-container matColumnDef="delete">
                <th mat-header-cell *matHeaderCellDef>Delete</th>
                <td mat-cell *matCellDef="let row">
                    <mat-icon
                        (click)="deletePatientRow(row)"
                        *ngIf="!row.get('deleted')?.value"
                        style="cursor:pointer"
                        >delete
                    </mat-icon>
                    <mat-icon
                        (click)="deletePatientRow(row)"
                        *ngIf="row.get('deleted')?.value"
                        style="cursor:pointer"
                        >undo
                    </mat-icon>
                </td>
            </ng-container>

            <tr
                mat-header-row
                *matHeaderRowDef="patientArrayDisplayedColumns"
            ></tr>
            <tr
                (click)="toggleRow(row)"
                [class.patientSelected]="selection.isSelected(row)"
                mat-row
                *matRowDef="let row; columns: patientArrayDisplayedColumns; let i = index"
                [class.deleted]="row.get('deleted')?.value"
                [class.invalid-row]="row.invalid && showMainProblemError[i]"
            ></tr>
        </table>
    </div>
    <div fxLayout="row-reverse">
        <button
            #addPatientBtn
            class="addCallerButton"
            type="button"
            (click)="addPatientRow()"
            mat-mini-fab
            color="primary"
        >
            <mat-icon>add</mat-icon>
        </button>
    </div>
</fieldset>
